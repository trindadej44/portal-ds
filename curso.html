<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conteúdo do Curso</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
    background-color: #f0f2f5;
    font-family: 'Roboto', sans-serif;
    color: #444;
}

.container {
    display: flex;
    margin-top: 30px;
}

.sidebar {
    position: fixed;
    top: 50px;
    left: 0;
    width: 250px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    padding: 20px;
    height: calc(100vh - 50px);
    overflow-y: auto;
}

.sidebar h4 {
    font-size: 1.2rem;
    color: #007bff;
    font-weight: bold;
    margin-bottom: 15px;
}

.sidebar .btn {
    font-size: 0.9rem;
    text-align: left;
    padding: 10px 15px;
    border-radius: 6px;
    transition: background-color 0.3s, color 0.3s;
}

.sidebar .btn:hover {
    background-color: #e6f0ff;
    color: #007bff;
}

.content-area {
    margin-left: 280px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    padding: 30px;
    margin-top: 30px;
}

h2 {
    font-size: 2rem;
    color: #007bff;
    font-weight: bold;
    margin-bottom: 25px;
}

.video-container {
    position: relative;
    padding-bottom: 56.25%;
    height: 0;
    overflow: hidden;
    border-radius: 12px;
    margin-top: 20px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.video-container iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: none;
}

.course-info {
    background: #f9fafc;
    padding: 20px;
    border-radius: 8px;
    margin-top: 25px;
    font-size: 0.9rem;
    color: #555;
}

.btn-primary {
    background-color: #007bff;
    border: none;
    font-weight: bold;
    transition: background-color 0.3s;
}

.btn-primary:hover {
    background-color: #0056b3;
}

.questionario {
    background: #f0f8ff;
    border-radius: 8px;
    padding: 25px;
    margin-top: 30px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.question {
    margin-bottom: 25px;
}
        #star-rating {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .star {
            font-size: 28px;
            cursor: pointer;
            color: #ccc;
        }
        .star:hover,
        .star.selected {
            color: gold;
        }

        



    </style>
</head>
<body>
    <script src="https://www.youtube.com/iframe_api"></script>

    <div class="sidebar">
        <h4>Módulos do Curso</h4>
        <div class="accordion" id="moduleAccordion">
            <button class="btn btn-light btn-block" onclick="changeModule('basico')">Módulo Básico</button>
            <button class="btn btn-light btn-block" onclick="changeModule('intermediario')">Módulo Intermediário</button>
            <button class="btn btn-light btn-block" onclick="changeModule('avancado')">Módulo Avançado</button>
        </div>
        
    </div>

    <div class="content-area">
        <h2 id="course-title">Título do Curso</h2>
        
        <div class="video-container">
            <iframe id="course-video" 
    width="560" 
    height="315" 
    src="" 
    title="YouTube video player" 
    frameborder="0" 
    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
    referrerpolicy="strict-origin-when-cross-origin" 
    allowfullscreen>
</iframe>

        </div>
        
        <div id="course-description" class="mt-4"></div>

        <div id="course-info" class="course-info">
            <p><strong>Instrutor:</strong> <span id="course-instructor"></span></p>
            <p><strong>Duração:</strong> <span id="course-duration"></span> minutos</p>
            <p><strong>Categoria:</strong> <span id="course-category"></span></p>
            
            <div id="star-rating">
                <span class="star" data-value="1">★</span>
                <span class="star" data-value="2">★</span>
                <span class="star" data-value="3">★</span>
                <span class="star" data-value="4">★</span>
                <span class="star" data-value="5">★</span>
            </div>
            <button id="submit-rating" class="btn btn-primary mt-2">Enviar Avaliação</button>
            <p>Média: <span id="average-rating">0.00</span></p>
        </div>
        
        <iframe src="https://trinket.io/embed/python/9e5b548e6ede" width="100%" height="356" frameborder="0" marginwidth="0" marginheight="0" allowfullscreen></iframe>
        <a href="dashboard.html" class="btn btn-primary mt-4">Voltar</a>
        <button id="open-quiz" class="btn btn-primary mt-4" onclick="openQuizModal()">Fazer Prova</button>

        <!-- Modal for Quiz -->
        <div class="modal fade" id="quizModal" tabindex="-1" role="dialog" aria-labelledby="quizModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="quizModalLabel">Questionário</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body" id="quiz-content">
                        <!-- Questions will be populated here -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                        <button type="button" class="btn btn-primary" id="submit-quiz">Enviar Respostas</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    
    

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        let questionsData = [];

async function openQuizModal() {
    const urlParams = new URLSearchParams(window.location.search);
    const courseId = urlParams.get('id');

    const response = await fetch(`http://localhost:3001/api/questions?course_id=${courseId}`);
    questionsData = await response.json();

    let quizContent = '';
    questionsData.forEach((q, index) => {
        quizContent += `
            <div class="question">
                <p>${index + 1}. ${q.question_text}</p>
                <label><input type="radio" name="question${index}" value="A"> ${q.option_a}</label><br>
                <label><input type="radio" name="question${index}" value="B"> ${q.option_b}</label><br>
                <label><input type="radio" name="question${index}" value="C"> ${q.option_c}</label><br>
                <label><input type="radio" name="question${index}" value="D"> ${q.option_d}</label><br>
            </div>
        `;
    });

    document.getElementById('quiz-content').innerHTML = quizContent;
    $('#quizModal').modal('show'); // Show the modal
}

document.getElementById('submit-quiz').addEventListener('click', async () => {
    let score = 0;
    const questions = document.querySelectorAll('.question');

    questions.forEach((q, index) => {
        const selected = q.querySelector(`input[name="question${index}"]:checked`);
        if (selected && selected.value === questionsData[index].correct_option) {
            score++;
        }
    });

    alert(`Você acertou ${score} de ${questions.length} questões!`);

    // Redireciona para a página de certificado se o usuário acertar 4 ou mais questões
    if (score >= 4) {
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('user_id'); // Supondo que você tenha o ID do usuário na URL
        const courseId = urlParams.get('id');

        try {
            // Chama a API para descadastrar o usuário do curso
            const response = await fetch(`http://localhost:3001/api/unenroll`, { // Atualize para a rota correta
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ user_id: userId, course_id: courseId })
            });

            if (!response.ok) {
                throw new Error('Erro ao descadastrar do curso');
            }

            // Redireciona para a página de certificado
            window.location.href = 'certificado.html';
        } catch (error) {
            console.error('Erro ao descadastrar:', error);
            alert('Ocorreu um erro ao tentar descadastrar você do curso. Tente novamente.');
        }
    } else {
        $('#quizModal').modal('hide'); // Fecha o modal se não acertou o suficiente
    }
});

    </script>
    <script>
        let selectedRating = null;

        async function fetchCourseContent() {
    const urlParams = new URLSearchParams(window.location.search);
    const courseId = urlParams.get('id');

    const response = await fetch(`http://localhost:3001/api/courses/course-content?id=${courseId}`);
    courseContent = await response.json(); // Armazenar o conteúdo do curso na variável global

    document.getElementById('course-title').innerText = courseContent.name;
    document.getElementById('course-description').innerText = courseContent.description;
    document.getElementById('course-instructor').innerText = courseContent.instrutor;
    document.getElementById('course-duration').innerText = courseContent.duracao;
    document.getElementById('course-category').innerText = courseContent.categoria;

    // Carregar o vídeo do módulo básico por padrão
    changeModule('basico');

    const averageRating = await fetchAverageRating(courseId);
    document.getElementById('average-rating').innerText = averageRating;
}

function changeModule(module) {
    let videoUrl = '';
    const quizButton = document.getElementById('open-quiz'); // Referência ao botão "Fazer Prova"

    // Aqui, assume que os campos do banco de dados são 'video_url_basico', 'video_url_intermediario' e 'video_url_avancado'
    switch (module) {
        case 'basico':
            videoUrl = courseContent.video_url_basico; // Obter URL do módulo básico
            quizButton.style.display = 'none'; // Esconde o botão "Fazer Prova"
            break;
        case 'intermediario':
            videoUrl = courseContent.video_url_intermediario; // Obter URL do módulo intermediário
            quizButton.style.display = 'none'; // Esconde o botão "Fazer Prova"
            break;
        case 'avancado':
            videoUrl = courseContent.video_url_avancado; // Obter URL do módulo avançado
            quizButton.style.display = 'block'; // Mostra o botão "Fazer Prova"
            break;
        default:
            console.error('Módulo inválido');
            return;
    }

    // Atualizar o src do iframe com o novo URL
    document.getElementById('course-video').src = `https://www.youtube.com/embed/${videoUrl}`;
}

// Inicializa o botão "Fazer Prova" como escondido
document.getElementById('open-quiz').style.display = 'none';


        async function fetchAverageRating(courseId) {
    const response = await fetch(`http://localhost:3001/api/ratings/average/${courseId}`);
    const data = await response.json();
    const averageRating = Math.trunc(data.average_rating || 0);
    updateStarRatingDisplay(averageRating); // Atualiza as estrelas com a média
    return averageRating;
}

        async function submitRating(courseId, rating) {
            await fetch('/api/ratings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ course_id: courseId, rating: rating })
            });
        }

        document.querySelectorAll('.star').forEach(star => {
            star.addEventListener('click', function() {
                selectedRating = this.getAttribute('data-value');
                document.querySelectorAll('.star').forEach(s => s.classList.remove('selected'));
                this.classList.add('selected');
            });
        });

        document.getElementById('submit-rating').addEventListener('click', async () => {
    const urlParams = new URLSearchParams(window.location.search);
    const courseId = urlParams.get('id');

    if (selectedRating) {
        await submitRating(courseId, selectedRating);
        const newAverage = await fetchAverageRating(courseId);
        document.getElementById('average-rating').innerText = newAverage;
    }
});

function updateStarRatingDisplay(rating) {
    const stars = document.querySelectorAll('.star');
    stars.forEach((star, index) => {
        if (index < rating) {
            star.classList.add('selected');
        } else {
            star.classList.remove('selected');
        }
    });
}  

        fetchCourseContent();
    </script>
</body> 
</html>
